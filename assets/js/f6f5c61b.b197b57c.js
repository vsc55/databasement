"use strict";(globalThis.webpackChunkdatabasement_docs=globalThis.webpackChunkdatabasement_docs||[]).push([[730],{2914:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"self-hosting/configuration/backup","title":"Backup","description":"Configure backup behavior, schedules, compression, and storage settings.","source":"@site/docs/self-hosting/configuration/backup.md","sourceDirName":"self-hosting/configuration","slug":"/self-hosting/configuration/backup","permalink":"/databasement/self-hosting/configuration/backup","draft":false,"unlisted":false,"editUrl":"https://github.com/David-Crty/databasement/tree/main/docs/docs/self-hosting/configuration/backup.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"selfHostingSidebar","previous":{"title":"Application","permalink":"/databasement/self-hosting/configuration/application"},"next":{"title":"Notification","permalink":"/databasement/self-hosting/configuration/notification"}}');var r=n(4848),d=n(8453);const t={sidebar_position:3},c="Backup",o={},l=[{value:"Backup Configuration",id:"backup-configuration",level:2},{value:"Compression Options",id:"compression-options",level:2},{value:"Encrypted Backups",id:"encrypted-backups",level:2},{value:"S3 Storage",id:"s3-storage",level:2},{value:"S3 IAM Permissions",id:"s3-iam-permissions",level:3},{value:"Access keys (Optional)",id:"access-keys-optional",level:3},{value:"S3-Compatible Storage (MinIO, etc.)",id:"s3-compatible-storage-minio-etc",level:3},{value:"IAM Role Assumption (Restricted Environments)",id:"iam-role-assumption-restricted-environments",level:3},{value:"AWS Profile Support",id:"aws-profile-support",level:3},{value:"All S3 Environment Variables",id:"all-s3-environment-variables",level:3},{value:"Show AWS Configuration",id:"show-aws-configuration",level:3},{value:"Complete Example",id:"complete-example",level:2}];function a(e){const s={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,d.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"backup",children:"Backup"})}),"\n",(0,r.jsx)(s.p,{children:"Configure backup behavior, schedules, compression, and storage settings."}),"\n",(0,r.jsx)(s.h2,{id:"backup-configuration",children:"Backup Configuration"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Variable"}),(0,r.jsx)(s.th,{children:"Description"}),(0,r.jsx)(s.th,{children:"Default"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"BACKUP_WORKING_DIRECTORY"})}),(0,r.jsx)(s.td,{children:"Temporary directory for backup operations"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"/tmp/backups"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"BACKUP_COMPRESSION"})}),(0,r.jsxs)(s.td,{children:["Compression algorithm: ",(0,r.jsx)(s.code,{children:"gzip"}),", ",(0,r.jsx)(s.code,{children:"zstd"}),", or ",(0,r.jsx)(s.code,{children:"encrypted"})]}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"gzip"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"BACKUP_COMPRESSION_LEVEL"})}),(0,r.jsx)(s.td,{children:"Compression level (1-9 for gzip/encrypted, 1-19 for zstd)"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"6"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"BACKUP_ENCRYPTION_KEY"})}),(0,r.jsx)(s.td,{children:"Encryption key for encrypted backups (AES-256)"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"env('APP_KEY')"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"BACKUP_JOB_TIMEOUT"})}),(0,r.jsx)(s.td,{children:"Maximum seconds a backup/restore job can run"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"7200"})," (2 hours)"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"BACKUP_JOB_TRIES"})}),(0,r.jsx)(s.td,{children:"Number of times to retry failed jobs"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"3"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"BACKUP_JOB_BACKOFF"})}),(0,r.jsx)(s.td,{children:"Seconds to wait before retrying"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"60"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"BACKUP_DAILY_CRON"})}),(0,r.jsx)(s.td,{children:"Cron schedule for daily backups"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"0 2 * * *"})," (2:00 AM)"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"BACKUP_WEEKLY_CRON"})}),(0,r.jsx)(s.td,{children:"Cron schedule for weekly backups"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"0 3 * * 0"})," (Sunday 3:00 AM)"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"BACKUP_CLEANUP_CRON"})}),(0,r.jsx)(s.td,{children:"Cron schedule for snapshot cleanup"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"0 4 * * *"})," (4:00 AM)"]})]})]})]}),"\n",(0,r.jsx)(s.h2,{id:"compression-options",children:"Compression Options"}),"\n",(0,r.jsxs)(s.p,{children:["By default, backups are compressed with ",(0,r.jsx)(s.strong,{children:"gzip"})," for maximum compatibility. You can switch to ",(0,r.jsx)(s.strong,{children:"zstd"})," for better compression ratios, or ",(0,r.jsx)(s.strong,{children:"encrypted"})," for AES-256 encrypted backups."]}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Method"}),(0,r.jsx)(s.th,{children:"CLI Tool"}),(0,r.jsx)(s.th,{children:"File Extension"}),(0,r.jsx)(s.th,{children:"Encrypted"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"gzip"})," (default)"]}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"gzip"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:".gz"})}),(0,r.jsx)(s.td,{children:"No"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"zstd"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"zstd"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:".zst"})}),(0,r.jsx)(s.td,{children:"No"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"encrypted"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"7z"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:".7z"})}),(0,r.jsx)(s.td,{children:"Yes (AES-256)"})]})]})]}),"\n",(0,r.jsx)(s.admonition,{type:"note",children:(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"zstd"})," typically provides 20-40% better compression than gzip at similar speeds. The default level of 6 provides a good balance between compression ratio and speed for both algorithms."]})}),"\n",(0,r.jsx)(s.h2,{id:"encrypted-backups",children:"Encrypted Backups"}),"\n",(0,r.jsxs)(s.p,{children:["When using ",(0,r.jsx)(s.code,{children:"encrypted"})," compression, backups are encrypted with AES-256 using 7-Zip. The encryption key defaults to ",(0,r.jsx)(s.code,{children:"APP_KEY"}),", but you can set a dedicated key:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"BACKUP_COMPRESSION=encrypted\nBACKUP_ENCRYPTION_KEY=base64:your-32-byte-key-here  # Optional, defaults to APP_KEY\n"})}),"\n",(0,r.jsx)(s.admonition,{type:"warning",children:(0,r.jsx)(s.p,{children:"If you change the encryption key, you will not be able to restore backups that were encrypted with the previous key. Keep your encryption key safe and backed up separately."})}),"\n",(0,r.jsx)(s.h2,{id:"s3-storage",children:"S3 Storage"}),"\n",(0,r.jsx)(s.p,{children:"Databasement supports AWS S3 and S3-compatible storage (MinIO, DigitalOcean Spaces, etc.) for backup volumes."}),"\n",(0,r.jsx)(s.p,{children:"We use ENV variables to configure the S3 client."}),"\n",(0,r.jsx)(s.h3,{id:"s3-iam-permissions",children:"S3 IAM Permissions"}),"\n",(0,r.jsx)(s.p,{children:"The AWS credentials need these permissions:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-json",children:'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Effect": "Allow",\n            "Action": [\n                "s3:PutObject",\n                "s3:GetObject",\n                "s3:DeleteObject",\n                "s3:ListBucket"\n            ],\n            "Resource": [\n                "arn:aws:s3:::your-bucket-name",\n                "arn:aws:s3:::your-bucket-name/*"\n            ]\n        }\n    ]\n}\n'})}),"\n",(0,r.jsx)(s.h3,{id:"access-keys-optional",children:"Access keys (Optional)"}),"\n",(0,r.jsx)(s.p,{children:"This is not recommended but for standard AWS access using access keys:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"AWS_ACCESS_KEY_ID=your-access-key\nAWS_SECRET_ACCESS_KEY=your-secret-key\nAWS_REGION=us-east-1\n"})}),"\n",(0,r.jsx)(s.h3,{id:"s3-compatible-storage-minio-etc",children:"S3-Compatible Storage (MinIO, etc.)"}),"\n",(0,r.jsx)(s.p,{children:"For S3-compatible storage providers, configure a custom endpoint:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"AWS_ENDPOINT_URL_S3=https://minio.yourdomain.com\nAWS_USE_PATH_STYLE_ENDPOINT=true\n# AWS_PUBLIC_ENDPOINT_URL_S3=https://minio.yourdomain.com\n"})}),"\n",(0,r.jsx)(s.admonition,{type:"tip",children:(0,r.jsxs)(s.p,{children:["If your internal endpoint differs from the public URL (e.g., ",(0,r.jsx)(s.code,{children:"http://minio:9000"})," vs ",(0,r.jsx)(s.code,{children:"http://localhost:9000"}),"), set ",(0,r.jsx)(s.code,{children:"AWS_PUBLIC_ENDPOINT_URL_S3"})," for presigned download URLs to work correctly in your browser."]})}),"\n",(0,r.jsx)(s.h3,{id:"iam-role-assumption-restricted-environments",children:"IAM Role Assumption (Restricted Environments)"}),"\n",(0,r.jsxs)(s.p,{children:["To force Databasement to assume an IAM role, set the ",(0,r.jsx)(s.code,{children:"AWS_CUSTOM_ROLE_ARN"})," environment variable:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"AWS_CUSTOM_ROLE_ARN=arn:aws:iam::123456789:role/your-role-name\n"})}),"\n",(0,r.jsx)(s.h3,{id:"aws-profile-support",children:"AWS Profile Support"}),"\n",(0,r.jsxs)(s.p,{children:["If using AWS credential profiles (from ",(0,r.jsx)(s.code,{children:"~/.aws/credentials"}),"):"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"AWS_S3_PROFILE=my-s3-profile\n"})}),"\n",(0,r.jsx)(s.h3,{id:"all-s3-environment-variables",children:"All S3 Environment Variables"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Variable"}),(0,r.jsx)(s.th,{children:"Description"}),(0,r.jsx)(s.th,{children:"Default"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"AWS_ACCESS_KEY_ID"})}),(0,r.jsx)(s.td,{children:"AWS access key (picked up automatically by SDK)"}),(0,r.jsx)(s.td,{children:"-"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"AWS_SECRET_ACCESS_KEY"})}),(0,r.jsx)(s.td,{children:"AWS secret key (picked up automatically by SDK)"}),(0,r.jsx)(s.td,{children:"-"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"AWS_REGION"})}),(0,r.jsx)(s.td,{children:"AWS region"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"us-east-1"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"AWS_ENDPOINT_URL_S3"})}),(0,r.jsx)(s.td,{children:"Custom S3 endpoint URL (internal)"}),(0,r.jsx)(s.td,{children:"-"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"AWS_PUBLIC_ENDPOINT_URL_S3"})}),(0,r.jsx)(s.td,{children:"Public S3 endpoint for presigned URLs"}),(0,r.jsx)(s.td,{children:"-"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"AWS_USE_PATH_STYLE_ENDPOINT"})}),(0,r.jsx)(s.td,{children:"Use path-style URLs (required for MinIO)"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"false"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"AWS_S3_PROFILE"})}),(0,r.jsx)(s.td,{children:"AWS credential profile for S3"}),(0,r.jsx)(s.td,{children:"-"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"AWS_CUSTOM_ROLE_ARN"})}),(0,r.jsx)(s.td,{children:"IAM custom role ARN to assume"}),(0,r.jsx)(s.td,{children:"-"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"AWS_ROLE_SESSION_NAME"})}),(0,r.jsx)(s.td,{children:"Session name for role assumption"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"databasement"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"AWS_ENDPOINT_URL_STS"})}),(0,r.jsx)(s.td,{children:"Custom STS endpoint URL"}),(0,r.jsx)(s.td,{children:"-"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"AWS_STS_PROFILE"})}),(0,r.jsx)(s.td,{children:"AWS credential profile for STS"}),(0,r.jsx)(s.td,{children:"-"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"show-aws-configuration",children:"Show AWS Configuration"}),"\n",(0,r.jsx)(s.p,{children:"Debug the aws configuration by running:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"php artisan config:show aws\n"})}),"\n",(0,r.jsxs)(s.p,{children:["This is where we create the S3 client: ",(0,r.jsx)(s.a,{href:"https://github.com/David-Crty/databasement/blob/main/app/Services/Backup/Filesystems/Awss3Filesystem.php",children:"app/Services/Backup/Filesystems/Awss3Filesystem.php"})]}),"\n",(0,r.jsx)(s.h2,{id:"complete-example",children:"Complete Example"}),"\n",(0,r.jsx)(s.p,{children:"Here's a complete backup configuration example:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"# Backup settings\nBACKUP_COMPRESSION=zstd\nBACKUP_COMPRESSION_LEVEL=6\nBACKUP_JOB_TIMEOUT=3600\nBACKUP_JOB_TRIES=3\n\n# S3 storage (MinIO example)\nAWS_ENDPOINT_URL_S3=http://minio:9000\nAWS_PUBLIC_ENDPOINT_URL_S3=https://minio.yourdomain.com\nAWS_USE_PATH_STYLE_ENDPOINT=true\nAWS_ACCESS_KEY_ID=your-access-key\nAWS_SECRET_ACCESS_KEY=your-secret-key\nAWS_REGION=us-east-1\n"})})]})}function h(e={}){const{wrapper:s}={...(0,d.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>t,x:()=>c});var i=n(6540);const r={},d=i.createContext(r);function t(e){const s=i.useContext(d);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(d.Provider,{value:s},e.children)}}}]);